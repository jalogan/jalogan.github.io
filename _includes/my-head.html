<!-- ==== GUMROAD PREFETCH & LIGHT LOADER ==== -->
<link rel="dns-prefetch" href="https://assets.gumroad.com">
<script>
(function () {
  function loadJS(src) {
    var s = document.createElement('script'); s.src = src; s.async = true;
    document.head.appendChild(s); return s;
  }
  function initGumroad() {
    // Lazy-load only if elements exist on the page
    if (document.querySelector('.gumroad-product-embed'))
      loadJS('https://gumroad.com/js/gumroad-embed.js');
    if (document.querySelector('.gumroad-button'))
      loadJS('https://gumroad.com/js/gumroad.js');
  }
  document.addEventListener('DOMContentLoaded', initGumroad);
  document.addEventListener('hy-push-state-load', initGumroad);
})();
</script>

<!-- ==== KATEX (DISPLAY $$...$$ + INLINE \(...\)) ==== -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>
<script>
(function () {
  var opts = {
    delimiters: [
      { left: "$$", right: "$$", display: true },
      { left: "\\(", right: "\\)", display: false }
    ],
    throwOnError: false,
    ignoredTags: ['script','noscript','style','textarea','pre','code'],
    ignoredClasses: ['no-math']
  };
  function renderAll() {
    if (window.renderMathInElement) {
      // Works whether PJAX is on or off
      var root = document.querySelector('hy-push-state') || document.body;
      renderMathInElement(root, opts);
    }
  }
  document.addEventListener('DOMContentLoaded', renderAll);
  document.addEventListener('hy-push-state-load', renderAll);
  window.addEventListener('pageshow', renderAll);
})();
</script>

<!-- ==== YOUR CUSTOM CSS ==== -->
<link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">

<!-- ==== FIGURE AUTO-NUMBERING (LIGHT) ==== -->
<script>
(function () {
  function updateFigureRefs() {
    var figs = Array.from(document.querySelectorAll("figure[id]"));
    var map  = new Map(figs.map(function(f,i){ return [f.id, i+1]; }));
    document.querySelectorAll("[data-fig-ref]").forEach(function(a){
      var id = (a.getAttribute("href")||"").replace(/^#/,'');
      var n  = map.get(id);
      if (n) a.textContent = "Figure " + n;
    });
  }
  function run(){ updateFigureRefs(); }
  document.addEventListener('DOMContentLoaded', run);
  document.addEventListener('hy-push-state-load', run);
  window.addEventListener('pageshow', run);
})();
</script>

<!-- ==== AUTOPLAY VIDEOS (SAFE) ==== -->
<script>
(function () {
  function start() {
    document.querySelectorAll("video[autoplay]").forEach(function(v){
      v.play().catch(function(){});
    });
  }
  document.addEventListener('DOMContentLoaded', start);
  document.addEventListener('hy-push-state-load', start);
  window.addEventListener('pageshow', start);
})();
</script>

<!-- ==== CUSTOM SWIPE (ONLY WHEN NO COVER) ==== -->
{%- unless page.cover -%}
  <script src="{{ '/assets/js/custom-swipe.js' | relative_url }}"></script>
{%- endunless -%}




<script>
document.addEventListener('DOMContentLoaded', () => {
  const dest = '/?no-cover#about';   // or '/#about' if you prefer to keep the cover visible

  // Rewrite any link that points exactly to the site root
  const sameOriginRoot = (a) =>
    a.origin === location.origin &&
    (a.pathname === '/' || a.pathname === '{{ "/" | relative_url }}');

  document.querySelectorAll('a[href]').forEach(a => {
    try {
      const url = new URL(a.href, location.href);
      if (sameOriginRoot(url)) a.href = dest;
    } catch(_) {}
  });
});
</script>
